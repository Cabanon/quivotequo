---
pagination:
    data: procedures
    size: 1
    alias: procedure
permalink: "procedure/{{ procedure.reference }}/index.html"
---
{% import "components.njk" as c %}
{% extends "parent.njk" %}
{% block main %}
<a href="/">◀️ Retourner à la recherche</a>
<h2>{{ procedure.title }}</h2>
{% set docs = docs | where('procedure', procedure.reference) %}
{% set doc_refs = docs | map('ref') %}
{% set procedure_votes = votes | where_in('doc', doc_refs) %}
{% set finals = procedure_votes | where('type', 'PRIMARY') %}
<h3>🎯 Résultat</h3>
<section>
{% if finals.length == 1 %}
    {% set final = finals[0] %}
    <h4>{{ c.adopted(final.result) }}</h4>
    {% if final.votes %}
        <h4>Votes de tous les députés européens</h4>
        <section>{{ c.simplebar(final.votes) }}</section>
        <h4>Votes des députés français</h4>
        {% set finals = votings | where('procedure_ref', procedure.reference ) | where('amendment', '') %}
        {% if finals.length == 1 %}
            <section>
                {{ c.fullbar(finals[0].positions) }}
                <a href="/vote/{{ finals[0].id }}">🗳 Voir le détail du vote</a>
            </section>
        {% else %}
            🔎 Vote introuvable
        {% endif %}
    {% else %}
        <h4>🔬 Détails du vote indisponibles</h4>
    {% endif %}
{% else %}
    🔎 Vote introuvable
{% endif %}
</section>
<h3>🏷 Sujets</h3>
<ul>
    {{ procedure.subject }}
    {% for code in procedure.subjects %}
        {% set subject = subjects | find('code', code) %}
        {% if subject %}
            <li><a href="/subject/{{ subject.code }}">{{ subject.name }}</a></li>
        {% else %}
            <li>{{ code }}</li>
        {% endif %}
    {% endfor %}
</ul>
<h3>📓 Amendements</h3>
{% for vote in procedure_votes | sort('amendment') %}
    {% set amendment = docs | find('ref', vote.doc) | map('amendments') | find('nr', vote.amendment) %}
    {% if amendment %}
        <h4>📝 Amendement n°{{ vote.amendment }} | {{ c.adopted(vote.result) }}</h4>
        {{ c.amendment(amendment) }}
        {% if vote.votes %}
            {% set voting = votings | where('procedure_ref', procedure.reference ) | find('amendment', vote.amendment) %}
            <a href="/vote/{{ voting.id }}">🗳 Voir le détail du vote</a>
        {% else %}
            🔬 Détails du vote indisponibles
        {% endif %}
    {% endif %}
{% endfor %}
<h4>Sources</h4>
<ul>
  <li><a href="{{ procedure.url | replace('.json', '.do') }}">ℹ️ Procédure</a></li>
  {% for doc in docs %}
    <li><a href="{{ doc.url }}">📜 Texte et amendements</a></li>
  {% endfor %}
  {% for url in procedure_votes | map('url') | unique %}
    <li><a href="{{ url | replace('.xml', '.html') }}">🗳 Détails des votes </a></li>
  {% endfor %}
</ul>
{% endblock %}